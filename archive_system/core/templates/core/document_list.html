<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DocuGuard | –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        .upload-area { border: 2px dashed #adb5bd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { background-color: #f8f9fa; border-color: #0d6efd; }
        .upload-area.dragover { background-color: #e3f2fd; border-color: #0d6efd; }
        .preview-frame { width: 100%; height: 500px; border: none; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid px-4 d-flex justify-content-between">
        <a class="navbar-brand" href="{% url 'home' %}">üìÇ DocuGuard</a>

        <div class="d-flex align-items-center">
            {% if user.is_authenticated %}
                <a href="{% url 'profile' %}" class="text-white me-3 text-decoration-none fw-bold d-inline-flex align-items-center gap-2">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" class="rounded-circle border border-white" width="32" height="32" style="object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-primary text-center border border-white" style="width:32px; height:32px; line-height:32px;">
                            {{ user.username|slice:":1"|upper }}
                        </div>
                    {% endif %}
                    <span>{{ user.username }}</span>
                </a>

                <form action="{% url 'logout' %}" method="post" class="m-0">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-light">–í—ã–π—Ç–∏</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-sm btn-primary">–í–æ–π—Ç–∏</a>
            {% endif %}
        </div>
    </div>
</nav>

<div class="container-fluid px-4">
    <div class="row">

        <div class="col-md-3 mb-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-secondary text-white">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'home' %}" class="list-group-item list-group-item-action {% if not current_category %}active{% endif %}">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</a>
                    {% for cat in categories %}
                    <a href="?category={{ cat.id }}" class="list-group-item list-group-item-action {% if current_category == cat.id %}active{% endif %}">{{ cat.name }}</a>
                    {% endfor %}
                </div>
            </div>

            {% if user.is_superuser %}
                <a href="{% url 'manage_categories' %}" class="btn btn-outline-dark w-100 mb-2">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</a>
                <a href="{% url 'audit_log' %}" class="btn btn-outline-danger w-100">üõ°Ô∏è –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞</a>
            {% endif %}
        </div>

        <div class="col-md-9">
            <div class="card shadow">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="m-0">üìë –î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                    </div>

                    <form method="get" class="row g-2 mb-4 align-items-center" id="filterForm">

                        {% if current_category %}
                            <input type="hidden" name="category" value="{{ current_category }}">
                        {% endif %}

                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                <input type="text" name="q" class="form-control" placeholder="–ù–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç (Enter)..." value="{{ search_query }}">
                            </div>
                        </div>

                        <div class="col-md-3">
                            <select name="type" class="form-select" onchange="document.getElementById('filterForm').submit()">
                                <option value="">üìÑ –í—Å–µ —Ç–∏–ø—ã</option>
                                <option value="pdf" {% if current_type == 'pdf' %}selected{% endif %}>üü• PDF</option>
                                <option value="word" {% if current_type == 'word' %}selected{% endif %}>üü¶ Word</option>
                                <option value="excel" {% if current_type == 'excel' %}selected{% endif %}>üü© Excel</option>
                                <option value="image" {% if current_type == 'image' %}selected{% endif %}>üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∏</option>
                                <option value="archive" {% if current_type == 'archive' %}selected{% endif %}>üì¶ –ê—Ä—Ö–∏–≤—ã</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <select name="sort" class="form-select" onchange="document.getElementById('filterForm').submit()">
                                <option value="date_desc" {% if current_sort == 'date_desc' %}selected{% endif %}>üìÖ –°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                                <option value="date_asc" {% if current_sort == 'date_asc' %}selected{% endif %}>üìÖ –°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                                <option value="name_asc" {% if current_sort == 'name_asc' %}selected{% endif %}>üî§ –ê-–Ø</option>
                                <option value="name_desc" {% if current_sort == 'name_desc' %}selected{% endif %}>üî§ –Ø-–ê</option>
                            </select>
                        </div>

                        {% if search_query or current_category or current_type %}
                        <div class="col-12 mt-2 text-end">
                            <a href="{% url 'home' %}" class="text-decoration-none text-muted small">
                                ‚ùå –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </a>
                        </div>
                        {% endif %}
                    </form>

                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>–¢–∏–ø</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–î–æ—Å—Ç—É–ø</th>
                                <th style="width: 180px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in docs %}
                            <tr>
                                <td class="text-center">
                                    {% if doc.is_image %}
                                        <i class="bi bi-image text-primary fs-4"></i>
                                    {% elif doc.get_extension == '.pdf' %}
                                        <i class="bi bi-file-earmark-pdf text-danger fs-4"></i>
                                    {% elif doc.get_extension == '.docx' or doc.get_extension == '.doc' %}
                                        <i class="bi bi-file-earmark-word text-primary fs-4"></i>
                                    {% elif doc.get_extension == '.xlsx' or doc.get_extension == '.xls' %}
                                        <i class="bi bi-file-earmark-excel text-success fs-4"></i>
                                    {% else %}
                                        <i class="bi bi-file-earmark-text text-secondary fs-4"></i>
                                    {% endif %}
                                </td>

                                <td>
                                    <div class="fw-bold">{{ doc.title }}</div>
                                    <small class="text-muted" style="font-size: 0.75rem;">
                                        {{ doc.get_extension|upper|slice:"1:" }}
                                    </small>
                                </td>

                                <td class="small text-muted">{{ doc.uploaded_at|date:"d.m.Y" }}</td>

                                <td>
                                    {% if doc.security_level == 'secret' %}<span class="badge bg-danger">üî¥ –°–µ–∫—Ä–µ—Ç–Ω–æ</span>
                                    {% elif doc.security_level == 'internal' %}<span class="badge bg-warning text-dark">üü° –°–ª—É–∂–µ–±–Ω—ã–π</span>
                                    {% else %}<span class="badge bg-success">üü¢ –û–±—â–∏–π</span>{% endif %}
                                </td>

                                <td>
                                    <div class="btn-group btn-group-sm">

                                        {% if doc.get_extension == '.pdf' or doc.is_image %}
                                            <a href="{% url 'open_file' doc.id %}" target="_blank" class="btn btn-outline-primary" title="–û—Ç–∫—Ä—ã—Ç—å">
                                                <i class="bi bi-eye"></i>
                                            </a>

                                        {% elif doc.get_extension == '.docx' %}
                                            <button class="btn btn-outline-primary"
                                                onclick="showPreview('{% url 'open_file' doc.id %}', '{{ doc.title }}', '{{ doc.get_extension }}')"
                                                title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                                                <i class="bi bi-eye"></i>
                                            </button>

                                        {% elif doc.get_extension == '.xlsx' or doc.get_extension == '.xls' %}
                                            <button class="btn btn-outline-primary"
                                                onclick="showPreview('{% url 'open_file' doc.id %}', '{{ doc.title }}', '{{ doc.get_extension }}')"
                                                title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü—ã">
                                                <i class="bi bi-eye"></i>
                                            </button>

                                        {% endif %}

                                        {% if user == doc.uploaded_by or user.is_superuser %}
                                        <a href="{% url 'share_link' doc.id %}" class="btn btn-outline-info" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                                            <i class="bi bi-link-45deg"></i>
                                        </a>
                                        {% endif %}

                                        <a href="{% url 'open_file' doc.id %}?download=1" class="btn btn-outline-success" title="–°–∫–∞—á–∞—Ç—å">
                                            <i class="bi bi-download"></i>
                                        </a>

                                        {% if user == doc.uploaded_by or user.is_superuser %}
                                            <button class="btn btn-outline-warning"
                                                onclick="editDoc('{{ doc.id }}', '{{ doc.title }}', '{{ doc.category.id|default_if_none:'' }}', '{{ doc.security_level }}')"
                                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                                <i class="bi bi-pencil"></i>
                                            </button>

                                            <button class="btn btn-outline-danger" onclick="confirmDelete('{% url 'delete_document' doc.id %}')" title="–£–¥–∞–ª–∏—Ç—å">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üçÉ</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="{% url 'upload' %}" method="post" enctype="multipart/form-data" class="modal-content">
            {% csrf_token %}
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" name="title" class="form-control mb-3" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" required>

                <select name="category" class="form-select mb-3">
                    <option value="">üìÇ –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
                </select>

                <select name="security_level" class="form-select mb-3">
                    <option value="public" selected>üü¢ –û–±—â–∏–π –¥–æ—Å—Ç—É–ø</option>
                    <option value="internal">üü° –°–ª—É–∂–µ–±–Ω—ã–π</option>
                    <option value="secret">üî¥ –°–µ–∫—Ä–µ—Ç–Ω–æ</option>
                </select>

                <div class="upload-area" id="dropZone">
                    <i class="bi bi-cloud-arrow-up fs-2"></i>
                    <p id="fileLabel">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</p>
                    <input type="file" name="file" id="fileInput" class="d-none" required>
                </div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="post" id="editForm" class="modal-content">
            {% csrf_token %}
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                    <input type="text" name="title" id="editTitle" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select name="category" id="editCategory" class="form-select">
                        <option value="">üìÇ –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞</label>
                    <select name="security_level" id="editSecurity" class="form-select">
                        <option value="public">üü¢ –û–±—â–∏–π –¥–æ—Å—Ç—É–ø</option>
                        <option value="internal">üü° –°–ª—É–∂–µ–±–Ω—ã–π</option>
                        <option value="secret">üî¥ –°–µ–∫—Ä–µ—Ç–Ω–æ</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-warning">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="previewBody">
                </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center pt-4">
                <h5 class="mb-3">–£–¥–∞–ª–∏—Ç—å? üóëÔ∏è</h5>
                <p class="text-muted">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            </div>
            <div class="modal-footer justify-content-center border-0 pb-4">
                <button class="btn btn-secondary" data-bs-dismiss="modal">–ù–µ—Ç</button>
                <a id="deleteConfirmBtn" href="#" class="btn btn-danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ------------------------------------------
    // 1. –§–£–ù–ö–¶–ò–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
    // ------------------------------------------
    function editDoc(id, title, catId, secLevel) {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
        document.getElementById('editTitle').value = title;
        document.getElementById('editCategory').value = catId;
        document.getElementById('editSecurity').value = secLevel;

        // –°—Ç–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const form = document.getElementById('editForm');
        form.action = `/edit/${id}/`;

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    // ------------------------------------------
    // 2. –§–£–ù–ö–¶–ò–Ø –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê (Word + Excel)
    // ------------------------------------------
    function showPreview(url, title, ext) {
        const body = document.getElementById('previewBody');
        document.getElementById('previewTitle').innerText = title;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        body.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
        new bootstrap.Modal(document.getElementById('previewModal')).show();

        ext = ext.toLowerCase();

        // A. WORD (DOCX)
        if (ext === '.docx') {
            fetch(url)
                .then(r => r.arrayBuffer())
                .then(b => mammoth.convertToHtml({arrayBuffer: b}))
                .then(res => {
                    body.innerHTML = `<div class="p-4 bg-white shadow-sm" style="overflow-y: auto; max-height: 80vh;">${res.value}</div>`;
                })
                .catch(err => showError(url));
        }

        // B. üëá –ù–û–í–û–ï: EXCEL (XLSX / XLS)
        else if (ext === '.xlsx' || ext === '.xls') {
            fetch(url)
                .then(res => res.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0]; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
                    const worksheet = workbook.Sheets[firstSheetName];

                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ HTML —Ç–∞–±–ª–∏—Ü—É
                    const htmlString = XLSX.utils.sheet_to_html(worksheet, { id: "excelTable", editable: false });

                    // –í—Å—Ç–∞–≤–ª—è–µ–º —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ —Å—Ç–∏–ª—è–º–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤–æ
                    body.innerHTML = `
                        <style>
                            #excelTable { width: 100%; border-collapse: collapse; }
                            #excelTable td, #excelTable th { border: 1px solid #dee2e6; padding: 8px; font-family: monospace;}
                        </style>
                        <div class="p-3 bg-white" style="overflow: auto; max-height: 80vh;">
                            ${htmlString}
                        </div>`;
                })
                .catch(err => showError(url));
        }
    }

    function showError(url) {
        const body = document.getElementById('previewBody');
        body.innerHTML = `
            <div class="text-center p-5">
                <h5>–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h5>
                <p class="text-muted">–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä.</p>
                <a href="${url}?download=1" class="btn btn-primary mt-3">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>
            </div>`;
    }

    function getDownloadFallback(url, msg="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω") {
        return `
            <div class="d-flex flex-column align-items-center justify-content-center" style="height: 300px;">
                <i class="bi bi-file-earmark-text display-1 text-secondary mb-3"></i>
                <h5>${msg}</h5>
                <a href="${url}" download class="btn btn-primary mt-3">
                    <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                </a>
            </div>`;
    }

    // ------------------------------------------
    // 3. –£–î–ê–õ–ï–ù–ò–ï
    // ------------------------------------------
    function confirmDelete(url) {
        document.getElementById('deleteConfirmBtn').href = url;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    // ------------------------------------------
    // 4. DRAG-AND-DROP + –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï
    // ------------------------------------------
    const dz = document.getElementById('dropZone');
    const fi = document.getElementById('fileInput');
    const titleInput = document.querySelector('input[name="title"]');

    function handleFile(file) {
        document.getElementById('fileLabel').innerText = file.name;
        // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—É—Å—Ç–æ–µ, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞
        if (titleInput.value.trim() === '') {
            titleInput.value = file.name;
        }
    }

    dz.onclick = () => fi.click();
    fi.onchange = () => { if (fi.files.length > 0) handleFile(fi.files[0]); };

    dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('dragover'); };
    dz.ondragleave = () => dz.classList.remove('dragover');

    dz.ondrop = (e) => {
        e.preventDefault();
        dz.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            fi.files = e.dataTransfer.files;
            handleFile(fi.files[0]);
        }
    };
</script>

</body>
</html>